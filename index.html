<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Selmas Böcker</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <h1>Selmas Böcker</h1>
    
    <div class="add-book">
        <input type="text" id="bookInput" placeholder="Lägg till en ny bok...">
        <button onclick="addBook()">Lägg till</button>
    </div>

    <div class="stats">
        <span class="stat-item" data-status="unread">
            <span class="stat-label">Olästa:</span>
            <span class="stat-value" id="unreadCount">0</span>
        </span>
        <span class="stat-item" data-status="reading">
            <span class="stat-label">Läser:</span>
            <span class="stat-value" id="readingCount">0</span>
        </span>
        <span class="stat-item" data-status="completed">
            <span class="stat-label">Lästa:</span>
            <span class="stat-value" id="completedCount">0</span>
        </span>
    </div>

    <div class="view-switcher">
        <button class="view-button active" data-view="list">Lista</button>
        <button class="view-button" data-view="panel">Paneler</button>
    </div>

    <div class="list-view active">
        <ul class="book-list" id="bookList"></ul>
    </div>

    <div class="panel-view">
        <div class="panel" data-status="unread">
            <div class="panel-header">Olästa</div>
            <div class="panel-books"></div>
        </div>
        <div class="panel" data-status="reading">
            <div class="panel-header">Läser</div>
            <div class="panel-books"></div>
        </div>
        <div class="panel" data-status="completed">
            <div class="panel-header">Klara</div>
            <div class="panel-books"></div>
        </div>
    </div>

    <script>
        // Hämta böcker och vald vy från localStorage
        let books = JSON.parse(localStorage.getItem('books')) || [];
        let currentView = localStorage.getItem('currentView') || 'list';
        let draggedBook = null;

        // Uppdatera vyn
        function updateView(view) {
            currentView = view;
            localStorage.setItem('currentView', view);
            
            document.querySelectorAll('.view-button').forEach(button => {
                button.classList.toggle('active', button.dataset.view === view);
            });
            
            document.querySelector('.list-view').classList.toggle('active', view === 'list');
            document.querySelector('.panel-view').classList.toggle('active', view === 'panel');
            
            renderBooks();
        }

        // Lägg till click handlers för vy-knapparna
        document.querySelectorAll('.view-button').forEach(button => {
            button.addEventListener('click', () => updateView(button.dataset.view));
        });

        // Uppdatera statistik
        function updateStats() {
            const stats = books.reduce((acc, book) => {
                acc[book.status]++;
                return acc;
            }, {
                unread: 0,
                reading: 0,
                completed: 0
            });

            document.getElementById('unreadCount').textContent = stats.unread;
            document.getElementById('readingCount').textContent = stats.reading;
            document.getElementById('completedCount').textContent = stats.completed;
        }

        // Formatera datum för input field (YYYY-MM-DD)
        function formatDateForInput(date) {
            return new Date(date).toISOString().split('T')[0];
        }

        // Skapa stjärnbetyg element
        function createStarRating(book, index) {
            const container = document.createElement('div');
            container.className = 'star-rating';
            
            for (let i = 1; i <= 5; i++) {
                const star = document.createElement('span');
                star.className = 'star' + (i <= (book.rating || 0) ? ' filled' : '');
                star.textContent = '★';
                star.onclick = (e) => {
                    e.stopPropagation();
                    books[index].rating = i;
                    renderBooks();
                };
                container.appendChild(star);
            }
            
            return container;
        }

        // Skapa datum input element
        function createDateInput(book, index) {
            const container = document.createElement('div');
            container.className = 'completion-date';
            
            const label = document.createElement('label');
            label.textContent = 'Läst:';
            
            const input = document.createElement('input');
            input.type = 'date';
            input.value = formatDateForInput(book.completedDate || new Date());
            input.onchange = (e) => {
                books[index].completedDate = new Date(e.target.value).toISOString();
                renderBooks();
            };
            
            container.appendChild(label);
            container.appendChild(input);
            return container;
        }

        // Lägg till drag and drop handlers
        function addDragHandlers(element, book, index) {
            element.draggable = true;
            
            element.addEventListener('dragstart', (e) => {
                draggedBook = { book, index };
                element.classList.add('dragging');
                e.dataTransfer.effectAllowed = 'move';
            });

            element.addEventListener('dragend', () => {
                element.classList.remove('dragging');
                document.querySelectorAll('.panel').forEach(panel => {
                    panel.classList.remove('drag-over');
                });
            });
        }

        // Skapa bok element
        function createBookElement(book, index) {
            const li = document.createElement('li');
            li.className = 'book-item';
            
            const bookInfo = document.createElement('div');
            bookInfo.className = 'book-info';
            
            const title = document.createElement('span');
            title.className = 'book-title';
            title.textContent = book.title;
            
            const meta = document.createElement('div');
            meta.className = 'book-meta';
            
            if (book.status === 'completed') {
                meta.appendChild(createDateInput(book, index));
                meta.appendChild(createStarRating(book, index));
            }
            
            bookInfo.appendChild(title);
            if (meta.children.length > 0) {
                bookInfo.appendChild(meta);
            }
            
            const statusButton = document.createElement('button');
            statusButton.className = 'book-status';
            statusButton.setAttribute('data-status', book.status);
            statusButton.textContent = getStatusText(book.status);
            statusButton.onclick = () => toggleStatus(index);
            
            li.appendChild(bookInfo);
            li.appendChild(statusButton);

            // Lägg till drag and drop i panel-vyn
            if (currentView === 'panel') {
                addDragHandlers(li, book, index);
            }
            
            return li;
        }

        // Initiera drag and drop för paneler
        function initializePanelDragAndDrop() {
            document.querySelectorAll('.panel').forEach(panel => {
                panel.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    panel.classList.add('drag-over');
                });

                panel.addEventListener('dragleave', () => {
                    panel.classList.remove('drag-over');
                });

                panel.addEventListener('drop', (e) => {
                    e.preventDefault();
                    panel.classList.remove('drag-over');
                    
                    if (draggedBook) {
                        const newStatus = panel.dataset.status;
                        const { index } = draggedBook;
                        
                        // Uppdatera status och hantera completion date
                        if (newStatus === 'completed') {
                            books[index].completedDate = books[index].completedDate || new Date().toISOString();
                        } else if (books[index].status === 'completed') {
                            delete books[index].completedDate;
                            delete books[index].rating;
                        }
                        
                        books[index].status = newStatus;
                        draggedBook = null;
                        renderBooks();
                    }
                });
            });
        }

        // Rendera boklistan
        function renderBooks() {
            if (currentView === 'list') {
                const bookList = document.getElementById('bookList');
                bookList.innerHTML = '';
                books.forEach((book, index) => {
                    bookList.appendChild(createBookElement(book, index));
                });
            } else {
                document.querySelectorAll('.panel-books').forEach(panel => {
                    panel.innerHTML = '';
                });
                
                books.forEach((book, index) => {
                    const panel = document.querySelector(`.panel[data-status="${book.status}"] .panel-books`);
                    panel.appendChild(createBookElement(book, index));
                });
                
                initializePanelDragAndDrop();
            }
            
            // Spara till localStorage och uppdatera statistik och graf
            localStorage.setItem('books', JSON.stringify(books));
            updateStats();
        }

        // Lägg till en ny bok
        function addBook() {
            const input = document.getElementById('bookInput');
            const title = input.value.trim();
            
            if (title) {
                books.push({
                    title: title,
                    status: 'unread'
                });
                input.value = '';
                renderBooks();
            }
        }

        // Växla status på en bok
        function toggleStatus(index) {
            const statusOrder = ['unread', 'reading', 'completed'];
            const currentStatus = books[index].status;
            const currentIndex = statusOrder.indexOf(currentStatus);
            const nextIndex = (currentIndex + 1) % statusOrder.length;
            const newStatus = statusOrder[nextIndex];
            
            books[index].status = newStatus;
            
            // Lägg till datum när boken markeras som läst
            if (newStatus === 'completed') {
                books[index].completedDate = new Date().toISOString();
            } else {
                // Ta bort datum och betyg om boken inte längre är läst
                delete books[index].completedDate;
                delete books[index].rating;
            }
            
            renderBooks();
        }

        // Få text för status
        function getStatusText(status) {
            const statusTexts = {
                'unread': 'Oläst',
                'reading': 'Läser',
                'completed': 'Klar'
            };
            return statusTexts[status];
        }

        // Lägg till bok när man trycker Enter
        document.getElementById('bookInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                addBook();
            }
        });

        // Initial rendering
        updateView(currentView);
    </script>
</body>
</html>
